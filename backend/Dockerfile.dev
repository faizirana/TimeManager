FROM node:18-alpine

# Set working directory to workspace root
WORKDIR /app

# Copy workspace package files (for npm workspaces support)
COPY package*.json ./
COPY backend/package*.json ./backend/

# Install all workspace dependencies
RUN npm ci

# Copy backend source code
COPY backend ./backend

# Set working directory to backend
WORKDIR /app/backend

# Fix permissions and switch to non-root user
RUN chown -R node:node /app
USER node

EXPOSE 3000

# Dev command for Express with nodemon
CMD ["npm", "run", "dev"]
